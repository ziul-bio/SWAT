---
title: "stats_plots"
author: "Luiz and Morgan"
date: "2024-06-08"
output: html_document
---

# Loading libraries
```{r}
library(here)
library(lme4)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(multcomp)
library(broom)
library(viridis)
# for later plotting
library(cowplot)
library(scales)

```




# DMS Data preprocessing
```{r}
data <- read.csv(here("results/summary_results_DMS_esm2_150M_lassoCV.csv"))
data <- dplyr::select(data, Dataset, Compression_methd, Fold, R2_score_test, rho_score_test)
data <- filter(data, Dataset != "HIS7 YEAST")
data <- filter(data, Compression_methd != "pca1-2")

data

# Convert categorical variables to factors and releveling the mean to be the reference group
data$Compression_methd <- factor(data$Compression_methd)
data$Compression_methd <- relevel(data$Compression_methd, ref = "mean")
data$Dataset <- factor(data$Dataset)
data$Fold <- factor(data$Fold)
data
```



# DMS Fitting the lme4 model

Dependent Variable: The dependent variable (response). Here is R2_score_test.       

Fixed Effect: The predictor variables (fixed effects) can be numeric or categorical. Categorical variables should be factors.   
'Compression_methd' is included as a fixed effect to see how different compression methods influence the R2_score_test.     

Random Effects: The grouping variables (random effects) should be factors. In here are Dataset and Fold.   
Both Dataset and Fold are included as random effects to account for variability across datasets and cross-validation folds.  

```{r}
model <- lmer(R2_score_test ~ Compression_methd + (1 | Dataset) + (1|Fold), data=data)
#model <- lmer(R2_score_test ~ Compression_methd + (1 | Dataset), data=data)
########model <- lmer(rho_score_test ~ Compression_methd + (1 | Dataset) + (1|Fold), data=data)
#model <- lmer(rho_score_test ~ Compression_methd + (1 | Dataset), data=data)
summary(model)
```



```{r}
#glht_results <- summary(glht(model, linfct=c('Compression_methdbos=0',
#                             'Compression_methdiDCT=0',
#                              'Compression_methdmaxPool=0',
#                              'Compression_methdpca1=0',
#                              '`Compression_methdpca1-2`=0',
#                              'Compression_methdpca2=0',
#                              'Compression_methdrbf1=0',
#                              'Compression_methdrbf2=0',
#                              'Compression_methdsigmoid1=0',
#                              'Compression_methdsigmoid2=0')))



glht_results <- summary(glht(model, linfct=c(
                              'Compression_methdbos=0',
                              'Compression_methdiDCT1=0',
                              'Compression_methdiDCT2=0',
                              'Compression_methdiDCT3=0',
                              'Compression_methdiDCT4=0',
                              'Compression_methdiDCT5=0',
                              'Compression_methdmaxPool=0',
                              'Compression_methdpca1=0',
###                              '`Compression_methdpca1-2`=0',
                              'Compression_methdpca2=0',
                              'Compression_methdrbf1=0',
                              'Compression_methdrbf2=0',
                              'Compression_methdsigmoid1=0',
                              'Compression_methdsigmoid2=0')))

glht_results 
```


```{r}
#summary(glht(model, linfct=mcp(Compression_methd="Tukey")))
```


## Interpretation


The intercept in a regression model represents the expected value of the dependent variable (in this case, R2_score_test) 
when all predictor variables are set to zero. It's the baseline value from which other effects are measured.


Fixed effects are the estimated coefficients for the predictor variables in the model. These effects are assumed to be the 
same across all groups in the dataset. In your model, Compression_methd is treated as a fixed effect, meaning its impact on 
R2_score_test is consistent across all datasets.

Random effects account for variability within the data that is not explained by the fixed effects. They allow the model to 
consider differences across groups (e.g., different datasets or cross-validation folds). For example, if some datasets inherently
have higher or lower R2 scores, this variability is captured by including Dataset as a random effect.

Residuals are the differences between the observed values and the values predicted by the model. They represent the "error" 
or "noise" in the model. Residual analysis helps to check the assumptions of the model (e.g., normality and homoscedasticity 
of residuals).



# DMS Evaluating individual datasets

```{r}
# Tidy the results
tidy_glht <- tidy(glht_results)
#tidy_glht<- tidy_glht %>% dplyr::filter(contrast != #'Compression_methdiDCT')

ci <- tidy(confint(glht_results)) %>% dplyr::select("contrast", "conf.high", "conf.low")

res_glht = merge(tidy_glht, ci, by = 'contrast')



res_glht$contrast <- gsub("Compression_methd", "", res_glht$contrast)

#res_glht$contrast <- gsub("iDCT2", "iDCT", res_glht$contrast)


# Determine significance levels
res_glht$signif <- ifelse(res_glht$adj.p.value < 0.001, "***",
                 ifelse(res_glht$adj.p.value < 0.01, "**",
                 ifelse(res_glht$adj.p.value < 0.05, "*", "")))



res_glht
```



# Figure 2A: DMS Plotting lmer
```{r}
#, fig.width=2.5, fig.height=6, out.width = 100%, out.height = 100%

final_plot <- res_glht %>%
  ggplot(aes(y = fct_reorder(contrast, estimate), 
             x = estimate, 
             #color = contrast
             )) +
  geom_point() +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.2) +
  theme_minimal() +
  labs(
       y = "Compression Method",
       x = expression(R^2 * " Difference from Mean")
       ) +
  geom_vline(xintercept = 0, linetype = "dotted", color = '#000000', linewidth = 1) +

  scale_x_continuous(limit = c(-.25, 0.05),
  ) + 
  theme_minimal_vgrid(12, rel_small = 1) +  
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = "white"),
    axis.text.x=element_text(size=12),
    axis.text.y=element_text(size=10),

    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    plot.margin = margin(10,10,0,10)
  ) +
  ggtitle("DMS")

# ggsave(final_plot, 
#        filename = "fig2_iDCT_DMS_v12.png",
#        path = here("figs"),
#        width = 6,
#        height = 6,
#        dpi=600)


final_plot
  
```



# Sup 3A: DMS 150M/650M/15B Boxplot

```{r}

data_15B <- read.csv(here('results/summary_DMS_15B_lassoCV.csv'))

data_650M <- read.csv(here('results/summary_DMS_650M_lassoCV.csv'))

methods = c('mean', 'bos', 'iDCT1', 'iDCT2', 'iDCT3', 'iDCT4', 'iDCT5', 'maxPool', 'pca1', 'pca2', 'rbf1', 'rbf2', 'sigmoid1', 'sigmoid2')

datasets_small = c('BLAT ECOLX 2015', 'PABP doubles', 'TIM THETH', 'PABP singles', 'RL401 2014', 'DLG4 RAT', 'HSP82 YEAST', 'IF1 ECOLI', 'RASH HUMAN', 'RL401 2013')

grouped_150M <- data %>%
  filter(Compression_methd %in% methods) %>%
  filter(Dataset %in% datasets_small) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()


grouped_150M$param <- '150M'

grouped_15B <- data_15B %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()


grouped_15B$param <- '15B'



grouped_650M <- data_650M %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()

grouped_650M$param <- '650M'


combined_150M_650M_15B <- rbind(grouped_150M, grouped_650M, grouped_15B)

grouped_150M_650M_15B <- combined_150M_650M_15B %>%
  mutate(param = factor(param, levels = c("150M", "650M", "15B")))

```


```{r, fig.width=3, fig.height=3, out.width = 100%, out.height = 100%}

color_dict <- c("150M" = '#9ECAE1','650M' = '#4292C6', "15B" = '#254369')

boxplot_15B_150M <- grouped_150M_650M_15B %>%
  ggplot(aes(
    x = reorder(Compression_methd, -mean_score), 
    y = mean_score, 
    fill = param)) +
  geom_boxplot(alpha = 0.85) +
  scale_fill_manual(
    values = color_dict
    ) +
  ylim(0, 1) +
  labs(x = "", 
       y = expression(R^2), 
       fill = ""
       ) +
  theme_minimal_hgrid(12, rel_small = 1)+
  theme(
        legend.position = "top",
        panel.background = element_rect(fill = "white", 
                                        colour = "white"),
        plot.background = element_rect(fill = "white", 
                                       colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(0, 10, 0, 10))
        
  

# ggsave(boxplot_15B_150M, 
#        filename = "model_compare_lassoCV.png",
#        path = here('figs'),
#        width = 12,
#        height = 4,
#        dpi=600)


boxplot_15B_150M

```

# Figure 3A: DMS Viridis Gradient
```{r}
# relies on df built in "DMS 150M/650M/15B Boxplot" chunk

gradient_plot <- grouped_150M_650M_15B %>%
  filter(Compression_methd %in% c('mean')) %>%
  ggplot(aes(
    x = param, 
    y = mean_score, 
    group = Dataset, 
    color = mean_score
    )) +
    geom_line() +
    geom_point(shape = 21, 
               size = 2,  
               color = "black", 
               aes(fill = mean_score), 
               stroke = .2
               ) + 
    scale_color_viridis_c(begin = .2, 
                          end =.8, 
                          direction=-1) +
    scale_fill_viridis_c(begin = .2, 
                         end = .8, 
                         direction = -1, guide = "none") +
    labs(x = "", 
         y = expression(R^2), 
         #title = ""
         color = ""
         ) +
    theme_minimal_hgrid(12, rel_small = 1)+
    theme(
        #legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10))
  


# ggsave(gradient_plot, 
#        filename = "gradient_plot.png",
#        path = here('figs'),
#        width = 6,
#        height = 4,
#        dpi=600)      

gradient_plot

```
# Figure 5
```{r}
# Fig 5

data_with_size <- read.csv(here('results/lassoCV_DMS/summary_all_DMS_results_LassoCV_mean.csv'))

data_with_size <- data_with_size %>%
  group_by(Dataset, param) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE),
    datse_size = median(get('datse_size'))
  ) %>%
  ungroup()

data_with_size$param <- factor(data_with_size$param, levels = c("150M", "650M", "15B"))


```

```{r}


    #annotate("text", 
             #x = 1e3,
             #y = max(data_with_size$mean_score),  # Adjust to place it well
             #label = paste0("Slope: ", round(slope, 2), "\nRÂ²: ", round(r_squared, 2)), 
             #hjust = 0,
             #color = "black"
  #)


model_150M <- lm(mean_score ~ log(datse_size), data = data_with_size, subset = param == "150M")
slope_150M <- coef(model_150M)[2]
r_squared_150M <- summary(model_150M)$r.squared

label_150M <- paste("Slope:", round(slope_150M, 2), "\n", paste0("R^2: ", round(r_squared_150M, 2)))
#paste0("~R^{2} == "


model_650M <- lm(mean_score ~ log(datse_size), data = data_with_size, subset = param == "650M")
slope_650M <- coef(model_650M)[2]
r_squared_650M <- summary(model_650M)$r.squared

label_650M <- paste("Slope:", round(slope_650M, 2), "\n", paste("R^2:", round(r_squared_650M, 2)))


model_15B <- lm(mean_score ~ log(datse_size), data = data_with_size, subset = param == "15B")
slope_15B <- coef(model_15B)[2]
r_squared_15B <- summary(model_15B)$r.squared

label_15B <- paste("Slope:", round(slope_15B, 2), "\n", paste("R^2:", round(r_squared_15B, 2)))


data_text <- data.frame(
  labels = c(label_150M, label_650M, label_15B),
  param = c("150M", "650M", "15B"),
  x = c(2050, 2050, 2050),
  y = c(1.13, 1.13, 1.13)
)

data_text$param <- factor(data_text$param, levels = c("150M", "650M", "15B"))

print(data_text)
```



```{r}

# kept showing 10^3.44446447 etc, idk how else to remove them
# if the power is a whole number then show the label, else ""
label_function <- function(x) {
    ifelse(log10(x) %% 1 == 0, trans_format("log10", math_format(10^.x))(x), "")
  }


plot_param <- data_with_size %>%
    ggplot(aes(
      x = datse_size, 
      y = mean_score,
      #color = '#0072B2'
      )) +
    scale_x_continuous(limits = c(1000, NA),
                       trans = scales::log_trans(),
                       breaks = scales::log_breaks(),
                        
                       labels = label_function
                         #trans_format("log10", math_format(10^.x))
                       ) +
    #scale_y_continuous(limits = c(0, 0.8))+
      geom_smooth(method = 'lm', 
                formula = y ~ log(x), 
                color = "#D55E00", 
                se = TRUE, 
                fill = "#D55E00", 
                #fullrange = TRUE
                ) +
    geom_point(alpha = 1,
               color = '#0072B2'
              ) +
    
    geom_errorbar(
      aes(
        ymin = mean_score - std_score, 
        ymax = mean_score + std_score), 
      alpha = .7,
      color = '#0072B2'
      )+
  

  #annotate(geom='text', x=c(200), y=c(.8), label=c('Down'), size=50) +
  #annotate(geom='text', x=c(-7,7), y=c(270, 270), label=c(down, up), size=5) +
    
    labs(x = "Dataset Size", 
         y = expression(paste("Predicted ", R^2)),
         #title = param_vec[1]
         #title = cat("ESM2", param),
         #color = ""
         ) +
    theme_minimal_grid(12, rel_small = 1)+
    theme(
        #legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10)
        )+
  
        geom_text(
        data    = data_text,
        mapping = aes(x = x, y = y, label = labels),
        #parse=TRUE
        )
    





plot_param <- plot_param + facet_grid(cols = vars(param))
#plot_param <- plot_param + annotate("text", label = "Test", size = 4, x = 1500, y = 1.2)  



plot_param 

# ggsave(plot_param, 
#        filename = "plot_param.png",
#        path = here("figs"),
#        width = 8,
#        height = 3,
#        dpi=600)



```













# Pisces Data Preprocessing
```{r}
pisces_data <- read.csv(here('results/summary_results_pisces_esm2_150M_lassoCV.csv'))
#'Pisces_summary.csv'
pisces_data <- dplyr::select(pisces_data, c('Dataset', 'Compression_methd', 'Fold', 'R2_score_test', 'rho_score_test'))

#pisces_data <- filter(pisces_data, !Dataset %in% c('W freq', 'M freq','V freq', 'Y freq', 'D freq','C freq', 'F freq'))
pisces_data <- filter(pisces_data, !Compression_methd %in% c('pca1-2'))

pisces_data

# Convert categorical variables to factors and releveling the mean to be the reference group
pisces_data$Compression_methd <- factor(pisces_data$Compression_methd)
pisces_data$Compression_methd <- relevel(pisces_data$Compression_methd, ref = "mean")
pisces_data$Dataset <- factor(pisces_data$Dataset)
pisces_data$Fold <- factor(pisces_data$Fold)
pisces_data

```


```{r}
pisces_model <- lmer(R2_score_test ~ Compression_methd + (1 | Dataset) + (1|Fold), data=pisces_data)
summary(pisces_model)
```

```{r}
pisces_glht_results <- summary(glht(pisces_model, linfct=c('Compression_methdbos=0',
                             'Compression_methdiDCT1=0',
                             'Compression_methdiDCT2=0',
                             'Compression_methdiDCT3=0',
                             'Compression_methdiDCT4=0',
                             'Compression_methdiDCT5=0',
                              'Compression_methdmaxPool=0',
                              'Compression_methdpca1=0',
###                              '`Compression_methdpca1-2`=0',
                              'Compression_methdpca2=0',
                              'Compression_methdrbf1=0',
                              'Compression_methdrbf2=0',
                              'Compression_methdsigmoid1=0',
                              'Compression_methdsigmoid2=0')))

pisces_glht_results 

```

```{r}
# Tidy the results
pisces_tidy_glht <- tidy(pisces_glht_results)

pisces_ci <- tidy(confint(pisces_glht_results)) %>% dplyr::select("contrast", "conf.high", "conf.low")

pisces_res_glht = merge(pisces_tidy_glht, pisces_ci, by = 'contrast')



pisces_res_glht$contrast <- gsub("Compression_methd", "", pisces_res_glht$contrast)


# Determine significance levels
pisces_res_glht$signif <- ifelse(pisces_res_glht$adj.p.value < 0.001, "***",
                 ifelse(pisces_res_glht$adj.p.value < 0.01, "**",
                 ifelse(pisces_res_glht$adj.p.value < 0.05, "*", "")))



pisces_res_glht
```


# Figure 2B: Pisces lmer
```{r, fig.width=4, fig.height=8, out.width = 100%, out.height = 100%}

pisces_plot <- pisces_res_glht %>%
  ggplot(aes(
      y = fct_reorder(contrast, estimate), 
      x = estimate, 
      #color = contrast
      )) +
  geom_point() +
  geom_errorbar(aes(xmin = conf.low, 
                    xmax = conf.high), 
                width = 0.2) +
  theme_minimal() +
  labs(
       y = "Compression Method",
       x = expression(R^2 * " Difference from Mean"),
       ) +
  geom_vline(xintercept = 0, 
             linetype = "dotted", 
             color = '#000000', 
             linewidth = 1) +

  scale_x_continuous(limit = c(-.85, 0),
                     breaks = seq(-0.8, 0, by = 0.4)
                     ) + 
   theme_minimal_vgrid(12, rel_small = 1) +  
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.background = element_rect(fill = "white", colour = "white"),
    axis.text.y=element_text(size=10),

    panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
    axis.line = element_blank(),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    
    plot.margin = margin(10,10,0,10)
  ) +
  ggtitle("Pisces")

pisces_plot

# ggsave(pisces_plot, 
#        filename = "fig3_iDCT_pisces_v04.png",
#        path = here("figs"),
#        width = 6,
#        height = 6,
#        dpi=600)




  
```





# Sup 3B: Pisces 150M/650M/15B boxplot 
```{r}

#exclude_datasets <- c('F freq', 'M freq', 'C freq', 'D freq', 'Y freq', 'V freq', 'W freq', 'G freq', 'Q freq', 'S freq', 'P freq', 'H freq', 'T freq')

pisces_15B <- read.csv(here('results/summary_results_pisces_esm2_15B_lassoCV.csv'))

pisces_650M <- read.csv(here('results/summary_results_pisces_esm2_650M_lassoCV.csv'))


methods = c('mean', 'bos', 'iDCT1', 'iDCT2', 'iDCT3', 'iDCT4', 'iDCT5', 'maxPool', 'pca1', 'pca2', 'rbf1', 'rbf2', 'sigmoid1', 'sigmoid2')

grouped_pisces <- pisces_data %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()


grouped_pisces_15B <- pisces_15B %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()

grouped_pisces_15B$param <- '15B'

grouped_pisces$param <- '150M'

grouped_pisces_650M <- pisces_650M %>%
  filter(Compression_methd %in% methods) %>%
  group_by(Dataset, Compression_methd) %>%
  summarise(
    mean_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_score = sd(get('R2_score_test'), na.rm = TRUE)
  ) %>%
  ungroup()

grouped_pisces_650M$param <- '650M'


pic_150M_650M_15B <- rbind(grouped_pisces, grouped_pisces_650M, grouped_pisces_15B)

pisces_150M_650M_15B <- pic_150M_650M_15B %>%
  mutate(param = factor(param, levels = c("150M", "650M", "15B")))


```



```{r}

color_dict <- c("150M" = '#9ECAE1','650M' = '#4292C6', "15B" = '#254369')

pisces_boxplot <- pisces_150M_650M_15B %>%
 ggplot(aes(
    x = reorder(Compression_methd, -mean_score), 
    y = mean_score, 
    fill = param)) +
  geom_boxplot(alpha = 0.85) +
  scale_fill_manual(values = color_dict) +
  ylim(0, 1) +
  labs(x = "Compression Method", y = expression(R^2), fill = "Model Size") +
  theme_minimal_hgrid(12, rel_small = 1)+
  theme(
        legend.position = "none",

        panel.background = element_rect(fill = "white", 
                                        colour = "white"),
        plot.background = element_rect(fill = "white", 
                                       colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10))
        
  

# ggsave(pisces_boxplot, 
#        filename = "pisces_models_lassoCV.png",
#        path = here("figs"),
#        width = 12,
#        height = 4,
#        dpi=600)


pisces_boxplot

```


# Figure 3B: Pisces Viridis Gradient
```{r}
# relies on df built in "pisces 150M/650M/15B boxplot" chunk

gradient_pisces <- pisces_150M_650M_15B %>%
  filter(Compression_methd %in% c('mean')) %>%
  ggplot(aes(
    x = param, 
    y = mean_score, 
    group = Dataset, 
    color = mean_score
    )) +
    geom_line() +
    geom_point(shape = 21, 
               size = 2,  
               color = "black", 
               aes(fill = mean_score), 
               stroke = .2
               ) + 
    scale_color_viridis_c(begin = .2, 
                          end =.8, 
                          direction=-1
                          ) +
    scale_fill_viridis_c(begin = .2, 
                         end = .8, 
                         direction = -1, 
                         guide = "none"
                         ) +
    labs(x = "Model Size", 
         y = expression(R^2), 
         color = ""
         ) +
    theme_minimal_hgrid(12, rel_small = 1)+
    theme(
        #legend.position = "top",
        panel.background = element_rect(fill = "white", 
                                        colour = "white"),
        plot.background = element_rect(fill = "white", 
                                       colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(10, 10, 0, 10))
  


#ggsave(gradient_pisces, 
       # filename = "gradient_pisces.png",
       # path = here('figs'),
       # width = 6,
       # height = 4,
       # dpi=600)      

gradient_pisces


```






# Figure 4: His7 sampling (DMS)
```{r}
his7_sampling <- read.csv(here('results/HIS7_YEAST_Kondrashov2017_sampling_esm2_all.csv'))

```

```{r}
grouped_his7_sampling <- his7_sampling %>%
  group_by(Sample_size, Model) %>%
  summarise(
    mean_R2_score = mean(get('R2_score_test'), na.rm = TRUE),
    std_R2_score = sd(get('R2_score_test'), na.rm = TRUE),
    mean_coeff_score = mean(get('nun_zero_coefs'), na.rm = FALSE),
    std_coeff_score = sd(get('nun_zero_coefs'), na.rm = FALSE)
    
  ) %>%
  ungroup()

grouped_his7_sampling <- grouped_his7_sampling %>%
  mutate(Model = factor(Model, levels = c("150M", "650M", "15B")))

```


```{r}

color_dict <- c("150M" = '#9ECAE1','650M' = '#4292C6', "15B" = '#254369')
#color_dict <- c("150M" = '#7C9ACB','650M' = '#375D8F', "15B" = '#254369')
#08519C
#4292C6
#9ECAE1


his7_sample_R2_plot <- grouped_his7_sampling %>%
  ggplot(aes(
      x = Sample_size, 
      y = mean_R2_score,
      color = Model
      )) +
  scale_x_continuous(limits = c(92, NA),trans = scales::log_trans(),
                     breaks = scales::log_breaks(),
                     labels = trans_format("log10", math_format(10^.x))
                       ) +
  scale_y_continuous(limits = c(-.3, NA)) +
  geom_errorbar(aes(
      ymin = mean_R2_score - std_R2_score, 
      ymax = mean_R2_score + std_R2_score), 
      width = 0.1,
      alpha = 1,
      position = position_dodge(width = .2)
      ) +
  geom_line(position = position_dodge(width = 0.2))+
  geom_point(position = position_dodge(width = 0.2))+
  scale_color_manual(
    values = color_dict
    ) +
  
  labs(x= "", 
    y = expression(R^2), fill = ""
       ) +
  theme_minimal_grid(12, rel_small = 1)+
  theme(
        legend.position = "top",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(0, 10, 0, 10))
        
  
  

#ggsave(his7_sample_R2_plot, 
#       filename = "his7_sample_R2_plot.png",
#       path = here("figs"),
#       width = 8,
#       height = 5,
#       dpi=600)


his7_sample_R2_plot

```

```{r}

his7_sample_coeff_plot <- grouped_his7_sampling %>%
  ggplot(aes(
      x = Sample_size, 
      y = mean_coeff_score,
      color = Model
      )) +
  scale_x_continuous(limits = c(92, NA), trans = scales::log_trans(),
                     breaks = scales::log_breaks(),
                     labels = trans_format("log10", math_format(10^.x))
                       ) +
  #scale_y_continuous(limits = c(NA, 1500)) +
  geom_errorbar(aes(
      ymin = mean_coeff_score - std_coeff_score, 
      ymax = mean_coeff_score + std_coeff_score), 
      width = 0.1,
      alpha = 1,
      position = position_dodge(width = .2)
      ) +
  geom_line(position = position_dodge(width = 0.2))+
  geom_point(position = position_dodge(width = 0.2))+
  scale_color_manual(
    values = color_dict
    ) +
  
  labs(x= "Sample Size", 
    y = "Number of Features", fill = ""
       ) +
  theme_minimal_grid(12, rel_small = 1)+
  theme(
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = "white"),
        plot.background = element_rect(fill = "white", colour = "white"),
      

        panel.border = element_rect(color = "black", 
                                    fill = NA, 
                                    size = .5),
        axis.line = element_blank(),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        plot.margin = margin(0, 10, 0, 10))
        
  
  

#ggsave(his7_sample_coeff_plot, 
#       filename = "his7_sample_coeff_plot.png",
#       path = here("figs"),
#       width = 8,
#       height = 5,
#       dpi=600)


his7_sample_coeff_plot

```

```{r}
his7_sample_plot <- plot_grid(his7_sample_R2_plot, 
                        his7_sample_coeff_plot,
                        labels = c('A', 'B'), 
                        label_size = 12, 
                        rel_heights = c(1.1, 1),
                        ncol = 1)

#ggsave(his7_sample_plot, 
#       filename = "his7_sample_plot.png",
#       path = here("figs"),
#       width = 7,
#       height = 6,
#       dpi=600)

his7_sample_plot

```




#### Assembling Parts with Cowplot
# Figure 2 Assembly
```{r}
# cowplot for DMS 150M data

double_plot <- plot_grid(final_plot,
                  pisces_plot,
                  labels = c('A', 'B'), 
                  label_size = 12, 
                  rel_widths = c(1, 1)
                  )


#ggsave(double_plot, 
#       filename = "double_lmer.png",
#       path = here("figs"),
#       width = 8,
#       height = 4,
#       dpi=600)
double_plot

```
# Figure 3 Assembly
```{r}
gradient_plots <- plot_grid(gradient_plot, 
                        gradient_pisces,
                        labels = c('A', 'B'), 
                        label_size = 12, 
                        rel_heights = c(1, 1),
                        ncol = 1)

#ggsave(gradient_plots, 
#       filename = "gradient_plots.png",
#       path = here("figs"),
#       width = 6,
#       height = 8,
#       dpi=600)

gradient_plots

```


# supplementary figs 
# Supplementary Figure 3 Assembly 
```{r}
supp_multi_mod <- plot_grid(boxplot_15B_150M, 
                            pisces_boxplot, 
                            labels = c('A', 'B'), 
                            ncol = 1, 
                            rel_heights = c(1.1, 1))

#ggsave(supp_multi_mod, 
#       filename = "supp_multi_mod.png",
#       path = here("figs"),
#       width = 12,
#       height = 8,
#       dpi=600)

supp_multi_mod
```

# Supplementary Figure 1
```{r}

# mutate df so that it is in the correct form
# use code similar to mega plot above to do all the compression methods
# use cowplot to combine them all

supp_data_mutated = data %>%
  group_by(Dataset, Compression_methd) %>%
  summarize(mean_R2_score = mean(R2_score_test, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = Compression_methd, values_from = mean_R2_score)

```

```{r}
methods_no_mean <- c("maxPool", "iDCT5", 'iDCT4', "pca1", 'rbf1', 'sigmoid1', "bos", 'iDCT3', "pca2", 'sigmoid2', 'iDCT2', 'rbf2', 'iDCT1')
  
  #c("maxPool", 'bos', 'iDCT1', 'iDCT2', 'iDCT3', 'iDCT4', 'rbf1', 'rbf2', 'sigmoid1', 'sigmoid2', "pca1", "pca2", "rbf1", "rbf2")

  #c("bos", "iDCT", "maxPool","pca1", "pca2", "rbf1", "rbf2", "sigmoid1", "sigmoid2")



scatter_plots_list <- list()

for(method in methods_no_mean){
  dot_color = 'black'
  
  
  plot <- supp_data_mutated %>%
    ggplot(aes_string(x = "mean", y = method)) + 
    geom_point(size = 1, color = dot_color) +
    scale_x_continuous(limits = c(0, 1)) +
    scale_y_continuous(limits = c(0, 1)) +
    geom_abline(slope = 1, 
                intercept = 0, 
                linetype = "dashed", 
                color = '#0072B2') +
    labs(x = "mean", 
         y = method) +
    theme_minimal_grid(12, rel_small = 1) +
    theme(
      panel.background = element_rect(fill = "white", 
                                      colour = "white"),
      plot.background = element_rect(fill = "white", 
                                     colour = "white"),
      legend.position = "none",
      panel.border = element_rect(color = "black", 
                                  fill = NA, 
                                  size = .5
                                  ),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(8, 8, 8, 8)
    )
  
  scatter_plots_list <- c(scatter_plots_list, list(plot))

}

```


```{r}

final_methods_plot <- plot_grid(plotlist = scatter_plots_list, ncol =3)

#ggsave(final_methods_plot, 
#       filename = "sup1_DMS_results_R2.png",
#       path = here("figs"),
#       width = 9,
#       height = 12,
#       dpi=600)

final_methods_plot
```

# Supplementary Figure 2
```{r}
exclude_datasets <- c('F freq', 'M freq', 'C freq', 'D freq', 'Y freq', 'V freq', 'W freq', 'G freq', 'Q freq', 'S freq', 'P freq', 'H freq', 'T freq')
supp_pisces_mutated = pisces_data %>%
  group_by(Dataset, Compression_methd) %>%
  summarize(mean_R2_score = mean(R2_score_test, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = Compression_methd, values_from = mean_R2_score)

supp_pisces_mutated <- filter(supp_pisces_mutated, !(Dataset %in% exclude_datasets))

methods_no_mean <- c("bos", "maxPool", "iDCT5", "iDCT4", "iDCT3", "pca1", "iDCT2", "sigmoid1", "rbf1", 'iDCT1', 'pca2', 'sigmoid2', 'rbf2')
  #c("bos", "iDCT", "maxPool", "pca1", "pca2", "rbf1", "rbf2", "sigmoid1", "sigmoid2")

pisces_scatter_plots_list <- list()

for(method in methods_no_mean){

  dot_color = 'black'
  
  
  plot <- supp_pisces_mutated %>%
    ggplot(aes_string(x = "mean", y = method)) + 
    geom_point(size = 1, color = dot_color) +
    scale_x_continuous(limits = c(0, 1)) +
    scale_y_continuous(limits = c(0, 1)) +
    geom_abline(slope = 1, 
                intercept = 0, 
                linetype = "dashed", 
                color = '#0072B2'
                ) +
    labs(x = "mean", 
         y = method) +
    theme_minimal_grid(12, rel_small = 1) +
    theme(
      panel.background = element_rect(fill = "white", 
                                      colour = "white"),
      plot.background = element_rect(fill = "white", 
                                     colour = "white"),
      legend.position = "none",
      panel.border = element_rect(color = "black", 
                                  fill = NA, 
                                  size = .5),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(8, 8, 8, 8)
    )
  
  pisces_scatter_plots_list <- c(pisces_scatter_plots_list, list(plot))

}



final_methods_pisces <- plot_grid(plotlist = pisces_scatter_plots_list, ncol =3)

#ggsave(final_methods_pisces, 
#       filename = "sup3_pisces_R2.png",
#       path = here("figs"),
#       width = 9,
#       height = 12,
#       dpi=600)

final_methods_pisces



```


# Supplementary Figure 4:
```{r}

mean_grouped_150M_650M_15B <- grouped_150M_650M_15B %>%
  filter(Compression_methd %in% c('mean'))


mean_grouped_150M_650M_15B$param <- factor(mean_grouped_150M_650M_15B$param, levels = c("15B", "650M", "150M"))

# PABP doubles= largest, PABP_singles = smallest
inc_order = c('PABP singles', 'RL401 2013', 'RL401 2014', 'IF1 ECOLI', 'TIM THETH', 'DLG4 RAT', 'RASH HUMAN', 'HSP82 YEAST', 'BLAT ECOLX 2015', 'PABP doubles')

mean_grouped_150M_650M_15B$Dataset <- factor(mean_grouped_150M_650M_15B$Dataset, levels = inc_order)  

  

color_dict <- c("15B" = '#254369','650M' = '#4292C6', "150M" = '#9ECAE1')

DMS_barplot <- mean_grouped_150M_650M_15B %>%
  ggplot(aes(y = mean_score, 
         x = Dataset,
         fill = param
         ))+
  geom_bar(stat = 'identity', 
           width = 0.7,
           position = position_dodge(),
           alpha = 0.85) + 
  scale_fill_manual(values = color_dict)+
  geom_errorbar(aes(
                ymin = mean_score - std_score, 
                ymax = mean_score + std_score),
                width = 0.3,
                position = position_dodge(0.7)) + 
  coord_flip()+ 
  guides(fill = guide_legend(reverse = TRUE))+
  labs(x = "Dataset", 
       y = expression(R^2), 
       fill="Model") +
  theme_minimal_vgrid(12, rel_small = 1) +
  theme(panel.background = element_rect(fill = "white", 
                                        colour ="white"),
      plot.background = element_rect(fill = "white", 
                                     colour = "white"),
      legend.position = "top",
      panel.border = element_rect(color = "black", 
                                  fill = NA, 
                                  size = .5),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(0, 10, 0, 10)
    )
         


#ggsave(DMS_barplot, 
#       filename = "DMS_barplot.png",
#       path = here("figs"),
#       width = 7,
#       height = 10,
#       dpi=600)
   

 
DMS_barplot
         

```
# Supplementary Figure 5
```{r}

mean_pisces_150M_650M_15B <- pisces_150M_650M_15B %>%
  filter(Compression_methd %in% c('mean'))

mean_pisces_150M_650M_15B$param <- factor(mean_pisces_150M_650M_15B$param, levels = c("15B", "650M", "150M"))


color_dict <- c("15B" = '#254369','650M' = '#4292C6', "150M" = '#9ECAE1')


pisces_barplot <- mean_pisces_150M_650M_15B %>%

  ggplot(aes(y = mean_score, 
         x = fct_reorder(Dataset, mean_score),
         fill = param
         ))+
  geom_bar(stat = 'identity', 
           width = 0.7,
           position = position_dodge(),
           alpha = 0.85) + 
  scale_fill_manual(values = color_dict)+
  geom_errorbar(aes(
                ymin = mean_score - std_score, 
                ymax = mean_score + std_score),
                width = 0.3,
                position = position_dodge(0.7)) + 
  coord_flip()+ 
  guides(fill = guide_legend(reverse = TRUE))+
  labs(x = "Dataset", 
       y = expression(R^2), 
       fill='Model') +
  theme_minimal_vgrid(12, rel_small = 1) +
  theme(panel.background = element_rect(fill = "white", 
                                        colour ="white"),
      plot.background = element_rect(fill = "white", 
                                     colour = "white"),
      legend.position = "top",
      panel.border = element_rect(color = "black", 
                                  fill = NA, 
                                  size = .5),
      axis.line = element_blank(),
      axis.ticks.x = element_line(color = "black"),
      axis.ticks.y = element_line(color = "black"),
      plot.margin = margin(0, 10, 0, 10)
    )
         


#ggsave(pisces_barplot, 
#       filename = "pisces_barplot.png",
#       path = here("figs"),
#       width = 7,
#       height = 10,
#       dpi=600)
   

 
pisces_barplot
```




# extra code unused plots
```{r}
# methods = c('mean', 'maxPool')
# 
# 
# 
# grouped_data <- data %>%
#   filter(Compression_methd %in% methods) %>%
#   group_by(Dataset, Compression_methd) %>%
#   summarise(
#     mean_score = mean(get('R2_score_test'), na.rm = TRUE),
#     std_score = sd(get('R2_score_test'), na.rm = TRUE)
#   ) %>%
#   ungroup()
# 
# 
# mean_data <- grouped_data %>%
#   filter(Compression_methd == "mean")
# 
# ordered_levels <- mean_data %>%
#   arrange(mean_score) %>%
#   pull(Dataset)
# 
# grouped_data <- grouped_data %>%
#   mutate(Dataset = factor(Dataset, levels = ordered_levels))




```

```{r}
#, fig.width=4, fig.height=8, out.width = 100%, out.height = 100%
# custom_colors <- c("mean" = '#0072B2', "maxPool" = '#D55E00')
# 
# 
# scatter_150M <- grouped_data %>%
#   ggplot(aes(
#       x = mean_score, 
#       y = Dataset,
#       color = Compression_methd
#       )) +
#   geom_point(alpha = 1
#       ) +
#   geom_errorbarh(aes(
#       xmin = mean_score - std_score, 
#       xmax = mean_score + std_score), 
#       height = 0.3,
#       alpha = .7
#       ) +
#       scale_x_continuous(limits = c(0, .8)) + 
#   scale_color_manual(values = custom_colors) +
#   labs(x = "R2", 
#        y = "", 
#        color = "Compression Method"
#        ) +
#   
#   theme_minimal_vgrid(12, rel_small = 1)+
#   theme(
#         panel.background = element_rect(fill = "white", 
#                                         colour = "white"),
#         plot.background = element_rect(fill = "white", 
#                                        colour = "white"),
#         legend.position = "top",
#         panel.border = element_rect(color = "black", 
#                                     fill = NA, 
#                                     size = .5),
#         axis.text.y = element_text(size = 10),
#         axis.line = element_blank(),
#         axis.ticks.x = element_line(color = "black"),
#         axis.ticks.y = element_line(color = "black"),
# 
#         
#         plot.margin = margin(0, 0, 0, 0)) 
# 
# 
# #ggsave(scatter_150M, 
#       filename = "sup5_DMS_scatter.png",
#       path = here("figs"),
#       width = 8,
#       height = 10, #8
#       dpi=600)


#scatter_150M
```